<!DOCTYPE html>
<html lang="en">
<head profile="http://www.w3.org/2005/10/profile">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-177284059-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-177284059-1');
  </script>
  
  <meta charset="UTF-8">
  <meta name="description" content="OBSERVATIONS">
  <meta name="author" content="Martin Toman">
  <meta name=viewport content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <title>OBSERVATIONS - Synchronize flake inputs</title>

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Synchronize flake inputs">
  <meta name="twitter:description" content="How to not end up with 20 different compiler versions">

  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/font.css">
</head>
<body class="post">

  <header>
    <a href="https://tinybeachthor.github.io"><h1>Observations</h1></a>

    <p class="title">
      Synchronize flake inputs
    </p>
    <p class="date">Jun 22, 2022</p>
    <br>
    <div class="tags">
      <span>#nix</span>
      <span>#flakes</span>
    </div>
  </header>

  <article>
    <h1>Synchronize flake inputs</h1>
<p>When working across multiple rust crates, of course as nix flakes,
it is very easy to end up with multiple minor versions of the toolchain.
Which is annoying and does not help all that much at all -
the strong nix reproducibility is a nuisance in this case.</p>
<h2>Solution</h2>
<p>Using a super-flake to re-export the packages we can get the same version
of the toolchain for multiple crate flakes.</p>
<p>The super-flake will look something like this:</p>
<div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">inputs</span> = {</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">flake-utils.url</span> = github:numtide/flake-utils/master<span class="kw">;</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">nixpkgs.url</span> = github:NixOS/nixpkgs/nixos-22.05<span class="kw">;</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">rust-overlay</span> = {</span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>      <span class="ex">url</span> = github:oxalica/rust-overlay/master<span class="kw">;</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>      <span class="ex">inputs</span> = {</span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>        <span class="ex">nixpkgs.follows</span> = <span class="st">&quot;nixpkgs&quot;</span><span class="kw">;</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>        <span class="ex">flake-utils.follows</span> = <span class="st">&quot;flake-utils&quot;</span><span class="kw">;</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span>;</span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>    };</span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>  };</span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">outputs</span> = { self, flake-utils, nixpkgs, rust-overlay }:</span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>      <span class="ex">lib</span> = flake-utils.lib<span class="kw">;</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">//</span></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">flake-utils.lib.eachDefaultSystem</span> (system: rec</span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">{</span></span>
<span id="21"><a href="#21" aria-hidden="true" tabindex="-1"></a>      <span class="ex">packages</span> = (import nixpkgs {</span>
<span id="22"><a href="#22" aria-hidden="true" tabindex="-1"></a>        <span class="ex">inherit</span> system<span class="kw">;</span></span>
<span id="23"><a href="#23" aria-hidden="true" tabindex="-1"></a>        <span class="ex">overlays</span> = [</span>
<span id="24"><a href="#24" aria-hidden="true" tabindex="-1"></a>          <span class="ex">rust-overlay.overlay</span></span>
<span id="25"><a href="#25" aria-hidden="true" tabindex="-1"></a>        ];</span>
<span id="26"><a href="#26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span>);</span>
<span id="27"><a href="#27" aria-hidden="true" tabindex="-1"></a>    }); </span>
<span id="28"><a href="#28" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We re-export the <code>nixpkgs</code> with <code>rust-overlay</code> applied,
and also <code>flake-utils.lib</code> for convenience.</p>
<p>The usage is simple:</p>
<div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">inputs</span> = {</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">nix.url</span> = github:<span class="va">${REPO_OWNER}</span>/<span class="va">${REPO_NAME}</span>/master<span class="kw">;</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">}</span>;</span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">outputs</span> = { self, nix }:</span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">with</span> nix.lib<span class="kw">;</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">eachSystem</span> [ system.x86_64-linux ] (system: {</span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">devShell</span> = import ./shell.nix {</span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>        <span class="ex">pkgs</span> = nix.packages.<span class="va">${system}</span><span class="kw">;</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>      };</span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>  });</span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2>Bonus: auto-update</h2>
<p>To auto update the input we can add the following command to the end of
<a href="https://direnv.net/">.envrc</a>:</p>
<div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="ex">nix</span> flake update nix --commit-lock-file</span></code></pre></div>

  </article>

  <footer>
    <span>
      <a href="https://github.com/tinybeachthor/tinybeachthor.github.io/tree/master/posts">Content</a>
      licensed under
      <a href="https://github.com/tinybeachthor/tinybeachthor.github.io/blob/master/posts/LICENSE"> CC BY 4.0</a>.
    </span>
    <span>
      <a href="https://github.com/tinybeachthor/tinybeachthor.github.io">Code</a>
      licensed under
      <a href="https://github.com/tinybeachthor/tinybeachthor.github.io/blob/master/LICENSE">BSD 3-Clause</a>.
    </span>
  </footer>

<body>
</html>
